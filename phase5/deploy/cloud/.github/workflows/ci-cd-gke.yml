name: CI/CD Pipeline for Google Cloud GKE

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT }}
  GAR_LOCATION: us-central1
  REGISTRY: us-central1-docker.pkg.dev
  REPOSITORY: todo-repo
  IMAGE_NAME_BACKEND: todo-backend
  IMAGE_NAME_FRONTEND: todo-frontend
  CLUSTER_NAME: todo-gke-cluster
  ZONE: us-central1-a

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - uses: actions/checkout@v3

    - name: Google Auth
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    - name: Configure Docker for Google Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.REGISTRY }} -q

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build and push backend
      run: |
        docker build -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }} ./phase3/backend
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }}

    - name: Build and push frontend
      run: |
        docker build -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }} ./phase3/frontend
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }}

  deploy-to-gke:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v3

    - name: Google Auth
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3

    - name: Set up gcloud CLI
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT }}

    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} --zone ${{ env.ZONE }} --project ${{ env.PROJECT_ID }}

    - name: Update deployment with new image
      run: |
        kubectl set image deployment/backend -n todo-app backend=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }}
        kubectl set image deployment/frontend -n todo-app frontend=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }}

    - name: Verify deployment
      run: |
        kubectl rollout status deployment/backend -n todo-app
        kubectl rollout status deployment/frontend -n todo-app

    - name: Run tests
      run: |
        # Add your test commands here
        echo "Running post-deployment tests..."